<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" xmlns:sec="http://www.w3.org/1999/xhtml">
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org"
      lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Панель Администратора. Список пользователей</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
</head>
<body>


<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <div class="col-auto me-auto">
            <span class="navbar-brand mx-0 mb-0 h1" sec:authentication="name"></span>
            <span class="navbar-brand mx-0">with roles: </span>
            <span class="navbar-brand mx-0" th:each="role : ${#authentication.principal.authorities}"
                  th:text="${role.trimName} + ' '"></span>
        </div>
        <div class="col-auto">
            <div class="navbar-text">
                <a sec:authorize="isAuthenticated()" class="link-underline-dark" href="/logout">Log out</a>
                <a sec:authorize="!isAuthenticated()" class="link-underline-dark" href="/login">Log in</a>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid full">
    <div class="row vh-100">
        <div class="col-2">
            <div class="pt-3">
                <div class="row">
                    <a class="btn btn-primary text-start text-decoration-none" aria-current="page"
                       href="/admin">Admin</a>
                </div>
                <div class="row">
                    <a class="btn text-start text-decoration-none text-primary" aria-current="page"
                       href="/user">User</a>
                </div>
            </div>
        </div>
        <div class="col-10 px-0 bg-light">
            <div class="row p-4 mx-3">
                <div class="text-start">
                    <p class="fs-1 fw-bold">Admin panel</p>
                </div>
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/admin">User table</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{admin/adduser}">New user</a>
                    </li>
                </ul>
                <div class="border border-gray rounded-2 px-0">
                    <div class="border-bottom">
                        <p class="text-start fs-3 align-middle m-1 mx-3">Add new user</p>
                    </div>
                    <div class="bg-warning">
                        <div class="bg-white py-4 px-4">

                            <form id="addForm" enctype="multipart/form-data"
                                  novalidate>
                                <div class="row text-center justify-content-center">
                                    <div class="col-6 mb-3 mx-4">
                                        <label for="nick" class="form-label mb-0 fw-bold">Ник:</label><br>
                                        <input name="nickName" type="text" id="nick" class="form-control"/>
                                    </div>

                                    <div class="col-6 mb-3 mx-4">
                                        <label for="first_name" class="form-label mb-0 fw-bold">Имя юзера:</label><br>
                                        <input name="firstName" type="text" id="first_name" class="form-control"/>
                                    </div>

                                    <div class="col-6 mb-3 mx-4">
                                        <label for="last_name" class="form-label mb-0 fw-bold">Фамилия юзера:</label><br>
                                        <input name="lastName" type="text" id="last_name" class="form-control"/>
                                    </div>

                                    <div class="col-6 mb-3 mx-4">
                                        <label for="e_mail" class="form-label mb-0 fw-bold">Почта:</label><br>
                                        <input name="eMail" type="text" id="e_mail" class="form-control"/>
                                    </div>

                                    <div class="col-6 mb-3 mx-4">
                                        <label for="user_pswd" class="form-label mb-0 fw-bold">Пароль:</label><br>
                                        <input name="passwd" type="text" id="user_pswd" class="form-control"/>
                                    </div>

                                    <div class="col-6 mb-3 mx-4">
                                        <label for="roles" class="form-label mb-0 fw-bold">Роль:</label><br>
                                        <select name="roleFromForm" id="roles" class="form-select" size="2">

                                        </select>
                                    </div>
                                    <div class="col-6 mb-3 mx-4">
                                        <input id="addButton" type="button" value="Добавить" class="btn btn-success">
                                    </div>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<button id="btn-edit" class="btn btn-info text-white" data-id="113">Edit</button>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    const addForm = document.getElementById('addForm');
    const addButton = addForm.querySelector('#addButton')
    const inputNick = addForm.querySelector('#nick')
    const inputFirstName = addForm.querySelector('#first_name')
    const inputLastName = addForm.querySelector('#last_name')
    const inputMail = addForm.querySelector('#e_mail')
    const inputPassword = addForm.querySelector('#user_pswd')
    const selectRole = addForm.querySelector('#roles')

    fetch('/api/roles', {
        method: 'post',
        credentials: 'include',
        headers: {
            "Content-type": "application/x-www-form-urlencoded; charset=UTF-8"
        },
    })
        .then((response) => response.json())
        .then(function (data) {
            selectRole.options.length = 0
            for (let i = 0; i < data.length; i++) {
                selectRole.innerHTML = selectRole.innerHTML +
                    '<option value="' + data[i]['trimName'] + '">' + data[i]['trimName'] + '</option>';
            }

        })
        .catch(function (error) {
            console.log('Request failed', error);
        });

    addButton.onclick = function () {

        if(selectRole.value === null || selectRole.value === "") {
            selectRole.value = "USER"
        }
        const p = inputPassword.value
        if(p === undefined || p === "") {
            inputPassword.value = "password"
        }

        const jsonDTO = {
            "id" : 0,
            "nick" : inputNick.value,
            "firstName" : inputFirstName.value,
            "lastName" : inputLastName.value,
            "eMail" : inputMail.value,
            "rolesList" : [selectRole.value],
            "password" : inputPassword.value
        }

        fetch('/api/adduser', {
            method: 'post',
            credentials: 'include',
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            },
            body: JSON.stringify(jsonDTO)
        })
            .then(response => {
                if (response.ok) window.location.href = 'http://localhost:8080/admin';
            })
            .catch(function (error) {
                console.log('Request failed', error);
            });

    }

</script>

</body>
</html>
